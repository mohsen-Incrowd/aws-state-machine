"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChoreographyInsightsStack = void 0;
/*
  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
  Permission is hereby granted, free of charge, to any person obtaining a copy of this
  software and associated documentation files (the "Software"), to deal in the Software
  without restriction, including without limitation the rights to use, copy, modify,
  merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
  permit persons to whom the Software is furnished to do so.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
  INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
  PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
  SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
// SPDX-License-Identifier: MIT-0
const cdk = require("aws-cdk-lib");
const aws_stepfunctions_1 = require("aws-cdk-lib/aws-stepfunctions");
const aws_events_1 = require("aws-cdk-lib/aws-events");
const workflow_simulation_1 = require("./workflow-simulation");
const choreography_insights_1 = require("./choreography-insights");
const choreography_state_1 = require("./choreography-state");
class ChoreographyInsightsStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const eventBus = new aws_events_1.EventBus(this, "EventBus");
        const insights = new choreography_insights_1.ChoreographyInsights(this, "Choreography", { eventBus: eventBus });
        const builder = new choreography_state_1.ChoreographyStateBuilder(this, "Builder", {
            taskTokenTable: insights.taskTokensTable,
            entityId: aws_stepfunctions_1.JsonPath.stringAt("$$.Execution.Input.id")
        });
        //Order
        const orderWorkflow = this.orderWorkflowDefinition(builder);
        const orderChoreography = new choreography_insights_1.Choreography(this, "Order", {
            definition: orderWorkflow,
            startEvent: {
                pattern: { source: ["order"], detailType: ["Order Placed"] }
            },
            events: [{
                    pattern: { source: ["order"], detailType: [{ "anything-but": "Order Placed" }] }
                }]
        });
        insights.addChoreography(orderChoreography);
        //Car
        const carWorkflow = this.carWorkflowDefinition(builder);
        const carChoreography = new choreography_insights_1.Choreography(this, "Car", {
            definition: carWorkflow,
            startEvent: {
                pattern: { source: ["car"], detailType: ["Car Announced"] }
            },
            events: [{
                    pattern: { source: ["car"], detailType: [{ "anything-but": "Car Announced" }] }
                }]
        });
        insights.addChoreography(carChoreography);
        new cdk.CfnOutput(this, "apiKeyIdForBpAPI", {
            value: orderWorkflow.id,
        });
        //Workflow simulation
        new workflow_simulation_1.WorkflowSimulationStateMachine(this, "WorkflowSimulation", { eventBus: eventBus });
    }
    /**
     * Sample workflow #1 - Order processing for a marketplace, accepting requests and forwarding to service providers
     * 1. Order Placed: a new order has been placed. The state machine is waiting for the confermation
     * 2. Order Confirmed: the order has been confirmed by sending a request to the service provider. The state machine is waiting for the service provider to accept the order.
     * 3. Order Accepted: the service provider accepted the order. the state machine will wait for the order delivery aknowledgement
     * 4. Order Rejected: the service provider rejected the order. Marketplace should cancel the order. The state machine will wait for the Order Canceled event
     * 5. Order Canceled: The customer did not confirm the order or the service provider did not complete delivery. The state machine reach final state OrderCanceled.
     * 6. Order Delivered: When the service provider accept the order it proceeds with delivery and when it's done provide aknowledgement with an event. The state machine reach final state OrderCompleted.
     * @param builder
     * @returns
     */
    orderWorkflowDefinition(builder) {
        const waitForConfirmation = builder.withName("WaitForConfirmation").build();
        const waitForServiceProviderToAccept = builder.withName("WaitForServiceProviderAccept").build();
        const waitForServiceProviderDelivery = builder.withName("WaitForServiceProviderDelivery").build();
        const waitForCanceled = builder.withName("WaitForCanceled").build();
        const orderCanceled = new aws_stepfunctions_1.Succeed(this, "OrderCanceled");
        const orderCompleted = new aws_stepfunctions_1.Succeed(this, "OrderCompleted");
        const unexpectedTransition = new aws_stepfunctions_1.Fail(this, "UnexpectedTransition");
        const deliveryChoice = new aws_stepfunctions_1.Choice(this, "Delivered?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Order Delivered"), orderCompleted)
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Order Canceled"), orderCanceled)
            .otherwise(unexpectedTransition);
        const orderAcceptedBranch = waitForServiceProviderDelivery.next(deliveryChoice);
        const orderRejectedBranch = waitForCanceled
            .next(new aws_stepfunctions_1.Choice(this, "Canceled?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Order Canceled"), orderCanceled)
            .otherwise(unexpectedTransition));
        return waitForConfirmation
            .next(new aws_stepfunctions_1.Choice(this, "Confirmed?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Order Confirmed"), waitForServiceProviderToAccept
            .next(new aws_stepfunctions_1.Choice(this, "Accepted?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Order Accepted"), orderAcceptedBranch)
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Order Rejected"), orderRejectedBranch)
            .otherwise(unexpectedTransition)))
            .otherwise(unexpectedTransition));
    }
    /**
     * Sample workflow #2 - Car journey for a second hand car dealership
     * 1. Car Announcement: A supplier announce that a new car is available to be purchased from the dealer publishing a Car Announced event
     * 2. Inspection: The dealer perform an inspection on the car. At the end of the inspection a Inspection Completed event is published with the result (Success, Rejected)
     * 3. Preparation: When inspection is successful, the dealer buy the car from the supplier and prepare it for reselling it. The preparation involves 3 separate tasks
     *    3.1 Cleaning: Car is cleaned. At task completion, a Car Cleaned event is published
     *    3.2 Repairing: Eventual damages are repaired. At task completion, a Car Repaired event is published
     *    3.3 Evaluating: A reselling price is calculated for the car. At task completion, a Car Priced event is published
     * 4. Ready for Sale: The car is ready to be published to the selling channel
     * 5. On Sale: A Car Published event indicates that the car is advertized on sales channels (i.e. ecommerce, apps, etc).
     *    5.1 The car can also be removed from adv channels. This is aknowledged with a Car Unpublished event. This cause the transition back to the Ready for Sale state.
     * 6. Reserved: A Car Reserved event published on the bus indicates that the someone is interested in the car and the purchasing process is in progress.
     *    6.1 If purchasing is canceled, a Car Unreserved event is published which brings the workflow to the On Sale state
     * 7. Sold: Purchase is completed and a Car Sold event is published. When the car is sold 2 things need to happen:
     *    7.1 The dealer generate an invoice and send it to the buyer. At task completion, a Car Invoiced event is published
     *    7.2 The dealer deliver the car to the buyer. At task completion, a Car Invoiced event is published
     * @param builder
     * @returns
     */
    carWorkflowDefinition(builder) {
        const announced = builder.withName("Announced").build();
        const rejected = new aws_stepfunctions_1.Succeed(this, "Rejected");
        /**
         * Parallel state can model a set of events that do not have string ordering among themselves.
         * A car requires to be cleaned, repaired and priced before being advertized. Ordering of these events is not important.
         * What is important is that all 3 are completed.
         * */
        const inPreparation = new aws_stepfunctions_1.Parallel(this, "InPreparation");
        inPreparation.branch(builder.withName("Clean").withEventName("Car Cleaned").build(), //Create a state named 'Clean' which waits for an event with detailType = 'Car Cleaned'
        builder.withName("Repair").withEventName("Car Repaired").build(), //Create a state named 'Repair' which waits for an event with detailType = 'Car Repaired'
        builder.withName("Evaluate").withEventName("Car Priced").build() //Create a state named 'Evaluate' which waits for an event with detailType = 'Car Priced'
        );
        const ready = builder.withName("ReadyForSale").build();
        const available = builder.withName("OnSale").build();
        const reserved = builder.withName("Reserved").build();
        const sold = new aws_stepfunctions_1.Parallel(this, "Sold");
        sold.branch(builder.withName("Delivery").withEventName("Car Delivered").build(), builder.withName("Invoice").withEventName("Invoice Sent").build());
        const unexpectedTransition = new aws_stepfunctions_1.Fail(this, "Unexpected Transition");
        return announced
            .next(new aws_stepfunctions_1.Choice(this, "Is Accepted?")
            .when(aws_stepfunctions_1.Condition.and(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Inspection Completed"), aws_stepfunctions_1.Condition.stringEquals("$.detail.result", "Rejected")), rejected)
            .when(aws_stepfunctions_1.Condition.and(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Inspection Completed"), aws_stepfunctions_1.Condition.stringEquals("$.detail.result", "Success")), inPreparation.next(ready)
            .next(new aws_stepfunctions_1.Choice(this, "Is On Sale?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Car Published"), available
            .next(new aws_stepfunctions_1.Choice(this, "Is Reserved?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Car Unpublished"), ready)
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Car Reserved"), reserved
            .next(new aws_stepfunctions_1.Choice(this, "Is Sold?")
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Car Unreserved"), available)
            .when(aws_stepfunctions_1.Condition.stringEquals("$.eventName", "Car Sold"), sold)
            .otherwise(unexpectedTransition)))
            .otherwise(unexpectedTransition)))
            .otherwise(unexpectedTransition)))
            .otherwise(unexpectedTransition));
    }
}
exports.ChoreographyInsightsStack = ChoreographyInsightsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hvcmVvZ3JhcGh5LWluc2lnaHRzLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hvcmVvZ3JhcGh5LWluc2lnaHRzLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBOzs7Ozs7Ozs7Ozs7O0VBYUU7QUFDRixpQ0FBaUM7QUFDakMsbUNBQW1DO0FBRW5DLHFFQUFrSDtBQUNsSCx1REFBa0Q7QUFDbEQsK0RBQXVFO0FBQ3ZFLG1FQUE2RTtBQUM3RSw2REFBZ0U7QUFDaEUsTUFBYSx5QkFBMEIsU0FBUSxHQUFHLENBQUMsS0FBSztJQUV0RCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXNCO1FBQzlELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLE1BQU0sUUFBUSxHQUFHLElBQUkscUJBQVEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFaEQsTUFBTSxRQUFRLEdBQUcsSUFBSSw0Q0FBb0IsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFFeEYsTUFBTSxPQUFPLEdBQUcsSUFBSSw2Q0FBd0IsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1lBQzVELGNBQWMsRUFBRSxRQUFRLENBQUMsZUFBZTtZQUN4QyxRQUFRLEVBQUUsNEJBQVEsQ0FBQyxRQUFRLENBQUMsdUJBQXVCLENBQUM7U0FDckQsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1RCxNQUFNLGlCQUFpQixHQUFHLElBQUksb0NBQVksQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQ3hELFVBQVUsRUFBRSxhQUFhO1lBQ3pCLFVBQVUsRUFBRTtnQkFDVixPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFB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biAgQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5IG9mIHRoaXNcclxuICBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmVcclxuICB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksXHJcbiAgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0b1xyXG4gIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzby5cclxuICBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SIElNUExJRUQsXHJcbiAgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEFcclxuICBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUXHJcbiAgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OXHJcbiAgT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFXHJcbiAgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuXHJcbiovXHJcbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQtMFxyXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xyXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcclxuaW1wb3J0IHsgIENob2ljZSwgU3VjY2VlZCwgRmFpbCwgQ29uZGl0aW9uLCBQYXJhbGxlbCwgSUNoYWluYWJsZSwgSnNvblBhdGggfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXN0ZXBmdW5jdGlvbnNcIjtcclxuaW1wb3J0IHsgRXZlbnRCdXMgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWV2ZW50c1wiO1xyXG5pbXBvcnQgeyBXb3JrZmxvd1NpbXVsYXRpb25TdGF0ZU1hY2hpbmUgfSBmcm9tICcuL3dvcmtmbG93LXNpbXVsYXRpb24nO1xyXG5pbXBvcnQgeyBDaG9yZW9ncmFwaHksIENob3Jlb2dyYXBoeUluc2lnaHRzIH0gZnJvbSAnLi9jaG9yZW9ncmFwaHktaW5zaWdodHMnO1xyXG5pbXBvcnQgeyBDaG9yZW9ncmFwaHlTdGF0ZUJ1aWxkZXIgfSBmcm9tICcuL2Nob3Jlb2dyYXBoeS1zdGF0ZSc7XHJcbmV4cG9ydCBjbGFzcyBDaG9yZW9ncmFwaHlJbnNpZ2h0c1N0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcclxuICBcclxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XHJcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcclxuXHJcbiAgICBjb25zdCBldmVudEJ1cyA9IG5ldyBFdmVudEJ1cyh0aGlzLCBcIkV2ZW50QnVzXCIpO1xyXG4gICAgXHJcbiAgICBjb25zdCBpbnNpZ2h0cyA9IG5ldyBDaG9yZW9ncmFwaHlJbnNpZ2h0cyh0aGlzLCBcIkNob3Jlb2dyYXBoeVwiLCB7IGV2ZW50QnVzOiBldmVudEJ1cyB9KTtcclxuXHJcbiAgICBjb25zdCBidWlsZGVyID0gbmV3IENob3Jlb2dyYXBoeVN0YXRlQnVpbGRlcih0aGlzLCBcIkJ1aWxkZXJcIiwge1xyXG4gICAgICB0YXNrVG9rZW5UYWJsZTogaW5zaWdodHMudGFza1Rva2Vuc1RhYmxlLFxyXG4gICAgICBlbnRpdHlJZDogSnNvblBhdGguc3RyaW5nQXQoXCIkJC5FeGVjdXRpb24uSW5wdXQuaWRcIilcclxuICAgIH0pO1xyXG5cclxuICAgIC8vT3JkZXJcclxuICAgIGNvbnN0IG9yZGVyV29ya2Zsb3cgPSB0aGlzLm9yZGVyV29ya2Zsb3dEZWZpbml0aW9uKGJ1aWxkZXIpO1xyXG4gICAgY29uc3Qgb3JkZXJDaG9yZW9ncmFwaHkgPSBuZXcgQ2hvcmVvZ3JhcGh5KHRoaXMsIFwiT3JkZXJcIiwge1xyXG4gICAgICBkZWZpbml0aW9uOiBvcmRlcldvcmtmbG93LFxyXG4gICAgICBzdGFydEV2ZW50OiB7XHJcbiAgICAgICAgcGF0dGVybjogeyBzb3VyY2U6IFtcIm9yZGVyXCJdLCBkZXRhaWxUeXBlOiBbXCJPcmRlciBQbGFjZWRcIl0gfVxyXG4gICAgICB9LFxyXG4gICAgICBldmVudHM6IFt7XHJcbiAgICAgICAgcGF0dGVybjogeyBzb3VyY2U6IFtcIm9yZGVyXCJdLCBkZXRhaWxUeXBlOiBbIHsgXCJhbnl0aGluZy1idXRcIjogXCJPcmRlciBQbGFjZWRcIn0gXSBhcyBhbnlbXSB9XHJcbiAgICAgIH1dXHJcbiAgICB9KTtcclxuICAgIGluc2lnaHRzLmFkZENob3Jlb2dyYXBoeShvcmRlckNob3Jlb2dyYXBoeSk7XHJcblxyXG4gICAgLy9DYXJcclxuICAgIGNvbnN0IGNhcldvcmtmbG93ID0gdGhpcy5jYXJXb3JrZmxvd0RlZmluaXRpb24oYnVpbGRlcik7XHJcbiAgICBjb25zdCBjYXJDaG9yZW9ncmFwaHkgPSBuZXcgQ2hvcmVvZ3JhcGh5KHRoaXMsIFwiQ2FyXCIsIHtcclxuICAgICAgZGVmaW5pdGlvbjogY2FyV29ya2Zsb3csXHJcbiAgICAgIHN0YXJ0RXZlbnQ6IHtcclxuICAgICAgICBwYXR0ZXJuOiB7IHNvdXJjZTogW1wiY2FyXCJdLCBkZXRhaWxUeXBlOiBbXCJDYXIgQW5ub3VuY2VkXCJdIH1cclxuICAgICAgfSxcclxuICAgICAgZXZlbnRzOiBbe1xyXG4gICAgICAgIHBhdHRlcm46IHsgc291cmNlOiBbXCJjYXJcIl0sIGRldGFpbFR5cGU6IFsgeyBcImFueXRoaW5nLWJ1dFwiOiBcIkNhciBBbm5vdW5jZWRcIn0gXSBhcyBhbnlbXSB9XHJcbiAgICAgIH1dXHJcbiAgICB9KTtcclxuICAgIGluc2lnaHRzLmFkZENob3Jlb2dyYXBoeShjYXJDaG9yZW9ncmFwaHkpO1xyXG5cclxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwiYXBpS2V5SWRGb3JCcEFQSVwiLCB7XHJcbiAgICAgIHZhbHVlOm9yZGVyV29ya2Zsb3cuaWQsXHJcbiAgICB9KTtcclxuXHJcbiAgICAvL1dvcmtmbG93IHNpbXVsYXRpb25cclxuICAgIG5ldyBXb3JrZmxvd1NpbXVsYXRpb25TdGF0ZU1hY2hpbmUodGhpcywgXCJXb3JrZmxvd1NpbXVsYXRpb25cIiwgeyBldmVudEJ1czogZXZlbnRCdXMgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2FtcGxlIHdvcmtmbG93ICMxIC0gT3JkZXIgcHJvY2Vzc2luZyBmb3IgYSBtYXJrZXRwbGFjZSwgYWNjZXB0aW5nIHJlcXVlc3RzIGFuZCBmb3J3YXJkaW5nIHRvIHNlcnZpY2UgcHJvdmlkZXJzXHJcbiAgICogMS4gT3JkZXIgUGxhY2VkOiBhIG5ldyBvcmRlciBoYXMgYmVlbiBwbGFjZWQuIFRoZSBzdGF0ZSBtYWNoaW5lIGlzIHdhaXRpbmcgZm9yIHRoZSBjb25mZXJtYXRpb25cclxuICAgKiAyLiBPcmRlciBDb25maXJtZWQ6IHRoZSBvcmRlciBoYXMgYmVlbiBjb25maXJtZWQgYnkgc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZpY2UgcHJvdmlkZXIuIFRoZSBzdGF0ZSBtYWNoaW5lIGlzIHdhaXRpbmcgZm9yIHRoZSBzZXJ2aWNlIHByb3ZpZGVyIHRvIGFjY2VwdCB0aGUgb3JkZXIuXHJcbiAgICogMy4gT3JkZXIgQWNjZXB0ZWQ6IHRoZSBzZXJ2aWNlIHByb3ZpZGVyIGFjY2VwdGVkIHRoZSBvcmRlci4gdGhlIHN0YXRlIG1hY2hpbmUgd2lsbCB3YWl0IGZvciB0aGUgb3JkZXIgZGVsaXZlcnkgYWtub3dsZWRnZW1lbnRcclxuICAgKiA0LiBPcmRlciBSZWplY3RlZDogdGhlIHNlcnZpY2UgcHJvdmlkZXIgcmVqZWN0ZWQgdGhlIG9yZGVyLiBNYXJrZXRwbGFjZSBzaG91bGQgY2FuY2VsIHRoZSBvcmRlci4gVGhlIHN0YXRlIG1hY2hpbmUgd2lsbCB3YWl0IGZvciB0aGUgT3JkZXIgQ2FuY2VsZWQgZXZlbnRcclxuICAgKiA1LiBPcmRlciBDYW5jZWxlZDogVGhlIGN1c3RvbWVyIGRpZCBub3QgY29uZmlybSB0aGUgb3JkZXIgb3IgdGhlIHNlcnZpY2UgcHJvdmlkZXIgZGlkIG5vdCBjb21wbGV0ZSBkZWxpdmVyeS4gVGhlIHN0YXRlIG1hY2hpbmUgcmVhY2ggZmluYWwgc3RhdGUgT3JkZXJDYW5jZWxlZC5cclxuICAgKiA2LiBPcmRlciBEZWxpdmVyZWQ6IFdoZW4gdGhlIHNlcnZpY2UgcHJvdmlkZXIgYWNjZXB0IHRoZSBvcmRlciBpdCBwcm9jZWVkcyB3aXRoIGRlbGl2ZXJ5IGFuZCB3aGVuIGl0J3MgZG9uZSBwcm92aWRlIGFrbm93bGVkZ2VtZW50IHdpdGggYW4gZXZlbnQuIFRoZSBzdGF0ZSBtYWNoaW5lIHJlYWNoIGZpbmFsIHN0YXRlIE9yZGVyQ29tcGxldGVkLlxyXG4gICAqIEBwYXJhbSBidWlsZGVyIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIG9yZGVyV29ya2Zsb3dEZWZpbml0aW9uKGJ1aWxkZXI6IENob3Jlb2dyYXBoeVN0YXRlQnVpbGRlcik6IElDaGFpbmFibGUge1xyXG5cclxuICAgIGNvbnN0IHdhaXRGb3JDb25maXJtYXRpb24gPSBidWlsZGVyLndpdGhOYW1lKFwiV2FpdEZvckNvbmZpcm1hdGlvblwiKS5idWlsZCgpO1xyXG4gICAgY29uc3Qgd2FpdEZvclNlcnZpY2VQcm92aWRlclRvQWNjZXB0ID0gYnVpbGRlci53aXRoTmFtZShcIldhaXRGb3JTZXJ2aWNlUHJvdmlkZXJBY2NlcHRcIikuYnVpbGQoKTtcclxuICAgIGNvbnN0IHdhaXRGb3JTZXJ2aWNlUHJvdmlkZXJEZWxpdmVyeSA9IGJ1aWxkZXIud2l0aE5hbWUoXCJXYWl0Rm9yU2VydmljZVByb3ZpZGVyRGVsaXZlcnlcIikuYnVpbGQoKTtcclxuICAgIGNvbnN0IHdhaXRGb3JDYW5jZWxlZCA9IGJ1aWxkZXIud2l0aE5hbWUoXCJXYWl0Rm9yQ2FuY2VsZWRcIikuYnVpbGQoKTtcclxuXHJcbiAgICBjb25zdCBvcmRlckNhbmNlbGVkID0gbmV3IFN1Y2NlZWQodGhpcywgXCJPcmRlckNhbmNlbGVkXCIpO1xyXG4gICAgY29uc3Qgb3JkZXJDb21wbGV0ZWQgPSBuZXcgU3VjY2VlZCh0aGlzLCBcIk9yZGVyQ29tcGxldGVkXCIpO1xyXG4gICAgY29uc3QgdW5leHBlY3RlZFRyYW5zaXRpb24gPSBuZXcgRmFpbCh0aGlzLCBcIlVuZXhwZWN0ZWRUcmFuc2l0aW9uXCIpO1xyXG5cclxuICAgIGNvbnN0IGRlbGl2ZXJ5Q2hvaWNlID0gbmV3IENob2ljZSh0aGlzLCBcIkRlbGl2ZXJlZD9cIilcclxuICAgICAgLndoZW4oQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiT3JkZXIgRGVsaXZlcmVkXCIpLCBvcmRlckNvbXBsZXRlZClcclxuICAgICAgLndoZW4oQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiT3JkZXIgQ2FuY2VsZWRcIiksIG9yZGVyQ2FuY2VsZWQpXHJcbiAgICAgIC5vdGhlcndpc2UodW5leHBlY3RlZFRyYW5zaXRpb24pO1xyXG5cclxuICAgIGNvbnN0IG9yZGVyQWNjZXB0ZWRCcmFuY2ggPSB3YWl0Rm9yU2VydmljZVByb3ZpZGVyRGVsaXZlcnkubmV4dChkZWxpdmVyeUNob2ljZSk7XHJcblxyXG4gICAgY29uc3Qgb3JkZXJSZWplY3RlZEJyYW5jaCA9IHdhaXRGb3JDYW5jZWxlZFxyXG4gICAgICAubmV4dChuZXcgQ2hvaWNlKHRoaXMsIFwiQ2FuY2VsZWQ/XCIpXHJcbiAgICAgIC53aGVuKENvbmRpdGlvbi5zdHJpbmdFcXVhbHMoXCIkLmV2ZW50TmFtZVwiLCBcIk9yZGVyIENhbmNlbGVkXCIpLCBvcmRlckNhbmNlbGVkKVxyXG4gICAgICAub3RoZXJ3aXNlKHVuZXhwZWN0ZWRUcmFuc2l0aW9uKSk7XHJcblxyXG4gICAgcmV0dXJuIHdhaXRGb3JDb25maXJtYXRpb25cclxuICAgICAgLm5leHQobmV3IENob2ljZSh0aGlzLCBcIkNvbmZpcm1lZD9cIilcclxuICAgICAgICAud2hlbihDb25kaXRpb24uc3RyaW5nRXF1YWxzKFwiJC5ldmVudE5hbWVcIiwgXCJPcmRlciBDb25maXJtZWRcIiksXHJcbiAgICAgICAgICB3YWl0Rm9yU2VydmljZVByb3ZpZGVyVG9BY2NlcHRcclxuICAgICAgICAgIC5uZXh0KG5ldyBDaG9pY2UodGhpcywgXCJBY2NlcHRlZD9cIilcclxuICAgICAgICAgICAgLndoZW4oQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiT3JkZXIgQWNjZXB0ZWRcIiksIG9yZGVyQWNjZXB0ZWRCcmFuY2gpXHJcbiAgICAgICAgICAgIC53aGVuKENvbmRpdGlvbi5zdHJpbmdFcXVhbHMoXCIkLmV2ZW50TmFtZVwiLCBcIk9yZGVyIFJlamVjdGVkXCIpLCBvcmRlclJlamVjdGVkQnJhbmNoKVxyXG4gICAgICAgICAgICAub3RoZXJ3aXNlKHVuZXhwZWN0ZWRUcmFuc2l0aW9uKSkpXHJcbiAgICAgICAgLm90aGVyd2lzZSh1bmV4cGVjdGVkVHJhbnNpdGlvbilcclxuICAgICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNhbXBsZSB3b3JrZmxvdyAjMiAtIENhciBqb3VybmV5IGZvciBhIHNlY29uZCBoYW5kIGNhciBkZWFsZXJzaGlwXHJcbiAgICogMS4gQ2FyIEFubm91bmNlbWVudDogQSBzdXBwbGllciBhbm5vdW5jZSB0aGF0IGEgbmV3IGNhciBpcyBhdmFpbGFibGUgdG8gYmUgcHVyY2hhc2VkIGZyb20gdGhlIGRlYWxlciBwdWJsaXNoaW5nIGEgQ2FyIEFubm91bmNlZCBldmVudFxyXG4gICAqIDIuIEluc3BlY3Rpb246IFRoZSBkZWFsZXIgcGVyZm9ybSBhbiBpbnNwZWN0aW9uIG9uIHRoZSBjYXIuIEF0IHRoZSBlbmQgb2YgdGhlIGluc3BlY3Rpb24gYSBJbnNwZWN0aW9uIENvbXBsZXRlZCBldmVudCBpcyBwdWJsaXNoZWQgd2l0aCB0aGUgcmVzdWx0IChTdWNjZXNzLCBSZWplY3RlZClcclxuICAgKiAzLiBQcmVwYXJhdGlvbjogV2hlbiBpbnNwZWN0aW9uIGlzIHN1Y2Nlc3NmdWwsIHRoZSBkZWFsZXIgYnV5IHRoZSBjYXIgZnJvbSB0aGUgc3VwcGxpZXIgYW5kIHByZXBhcmUgaXQgZm9yIHJlc2VsbGluZyBpdC4gVGhlIHByZXBhcmF0aW9uIGludm9sdmVzIDMgc2VwYXJhdGUgdGFza3NcclxuICAgKiAgICAzLjEgQ2xlYW5pbmc6IENhciBpcyBjbGVhbmVkLiBBdCB0YXNrIGNvbXBsZXRpb24sIGEgQ2FyIENsZWFuZWQgZXZlbnQgaXMgcHVibGlzaGVkXHJcbiAgICogICAgMy4yIFJlcGFpcmluZzogRXZlbnR1YWwgZGFtYWdlcyBhcmUgcmVwYWlyZWQuIEF0IHRhc2sgY29tcGxldGlvbiwgYSBDYXIgUmVwYWlyZWQgZXZlbnQgaXMgcHVibGlzaGVkXHJcbiAgICogICAgMy4zIEV2YWx1YXRpbmc6IEEgcmVzZWxsaW5nIHByaWNlIGlzIGNhbGN1bGF0ZWQgZm9yIHRoZSBjYXIuIEF0IHRhc2sgY29tcGxldGlvbiwgYSBDYXIgUHJpY2VkIGV2ZW50IGlzIHB1Ymxpc2hlZFxyXG4gICAqIDQuIFJlYWR5IGZvciBTYWxlOiBUaGUgY2FyIGlzIHJlYWR5IHRvIGJlIHB1Ymxpc2hlZCB0byB0aGUgc2VsbGluZyBjaGFubmVsXHJcbiAgICogNS4gT24gU2FsZTogQSBDYXIgUHVibGlzaGVkIGV2ZW50IGluZGljYXRlcyB0aGF0IHRoZSBjYXIgaXMgYWR2ZXJ0aXplZCBvbiBzYWxlcyBjaGFubmVscyAoaS5lLiBlY29tbWVyY2UsIGFwcHMsIGV0YykuXHJcbiAgICogICAgNS4xIFRoZSBjYXIgY2FuIGFsc28gYmUgcmVtb3ZlZCBmcm9tIGFkdiBjaGFubmVscy4gVGhpcyBpcyBha25vd2xlZGdlZCB3aXRoIGEgQ2FyIFVucHVibGlzaGVkIGV2ZW50LiBUaGlzIGNhdXNlIHRoZSB0cmFuc2l0aW9uIGJhY2sgdG8gdGhlIFJlYWR5IGZvciBTYWxlIHN0YXRlLlxyXG4gICAqIDYuIFJlc2VydmVkOiBBIENhciBSZXNlcnZlZCBldmVudCBwdWJsaXNoZWQgb24gdGhlIGJ1cyBpbmRpY2F0ZXMgdGhhdCB0aGUgc29tZW9uZSBpcyBpbnRlcmVzdGVkIGluIHRoZSBjYXIgYW5kIHRoZSBwdXJjaGFzaW5nIHByb2Nlc3MgaXMgaW4gcHJvZ3Jlc3MuXHJcbiAgICogICAgNi4xIElmIHB1cmNoYXNpbmcgaXMgY2FuY2VsZWQsIGEgQ2FyIFVucmVzZXJ2ZWQgZXZlbnQgaXMgcHVibGlzaGVkIHdoaWNoIGJyaW5ncyB0aGUgd29ya2Zsb3cgdG8gdGhlIE9uIFNhbGUgc3RhdGVcclxuICAgKiA3LiBTb2xkOiBQdXJjaGFzZSBpcyBjb21wbGV0ZWQgYW5kIGEgQ2FyIFNvbGQgZXZlbnQgaXMgcHVibGlzaGVkLiBXaGVuIHRoZSBjYXIgaXMgc29sZCAyIHRoaW5ncyBuZWVkIHRvIGhhcHBlbjpcclxuICAgKiAgICA3LjEgVGhlIGRlYWxlciBnZW5lcmF0ZSBhbiBpbnZvaWNlIGFuZCBzZW5kIGl0IHRvIHRoZSBidXllci4gQXQgdGFzayBjb21wbGV0aW9uLCBhIENhciBJbnZvaWNlZCBldmVudCBpcyBwdWJsaXNoZWRcclxuICAgKiAgICA3LjIgVGhlIGRlYWxlciBkZWxpdmVyIHRoZSBjYXIgdG8gdGhlIGJ1eWVyLiBBdCB0YXNrIGNvbXBsZXRpb24sIGEgQ2FyIEludm9pY2VkIGV2ZW50IGlzIHB1Ymxpc2hlZFxyXG4gICAqIEBwYXJhbSBidWlsZGVyIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIGNhcldvcmtmbG93RGVmaW5pdGlvbihidWlsZGVyOiBDaG9yZW9ncmFwaHlTdGF0ZUJ1aWxkZXIpOiBJQ2hhaW5hYmxlIHtcclxuXHJcbiAgICBjb25zdCBhbm5vdW5jZWQgPSBidWlsZGVyLndpdGhOYW1lKFwiQW5ub3VuY2VkXCIpLmJ1aWxkKCk7XHJcbiAgICBjb25zdCByZWplY3RlZCA9IG5ldyBTdWNjZWVkKHRoaXMsIFwiUmVqZWN0ZWRcIik7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQYXJhbGxlbCBzdGF0ZSBjYW4gbW9kZWwgYSBzZXQgb2YgZXZlbnRzIHRoYXQgZG8gbm90IGhhdmUgc3RyaW5nIG9yZGVyaW5nIGFtb25nIHRoZW1zZWx2ZXMuXHJcbiAgICAgKiBBIGNhciByZXF1aXJlcyB0byBiZSBjbGVhbmVkLCByZXBhaXJlZCBhbmQgcHJpY2VkIGJlZm9yZSBiZWluZyBhZHZlcnRpemVkLiBPcmRlcmluZyBvZiB0aGVzZSBldmVudHMgaXMgbm90IGltcG9ydGFudC5cclxuICAgICAqIFdoYXQgaXMgaW1wb3J0YW50IGlzIHRoYXQgYWxsIDMgYXJlIGNvbXBsZXRlZC5cclxuICAgICAqICovXHJcbiAgICBjb25zdCBpblByZXBhcmF0aW9uID0gbmV3IFBhcmFsbGVsKHRoaXMsIFwiSW5QcmVwYXJhdGlvblwiKTtcclxuICAgIGluUHJlcGFyYXRpb24uYnJhbmNoKFxyXG4gICAgICBidWlsZGVyLndpdGhOYW1lKFwiQ2xlYW5cIikud2l0aEV2ZW50TmFtZShcIkNhciBDbGVhbmVkXCIpLmJ1aWxkKCksICAgLy9DcmVhdGUgYSBzdGF0ZSBuYW1lZCAnQ2xlYW4nIHdoaWNoIHdhaXRzIGZvciBhbiBldmVudCB3aXRoIGRldGFpbFR5cGUgPSAnQ2FyIENsZWFuZWQnXHJcbiAgICAgIGJ1aWxkZXIud2l0aE5hbWUoXCJSZXBhaXJcIikud2l0aEV2ZW50TmFtZShcIkNhciBSZXBhaXJlZFwiKS5idWlsZCgpLCAvL0NyZWF0ZSBhIHN0YXRlIG5hbWVkICdSZXBhaXInIHdoaWNoIHdhaXRzIGZvciBhbiBldmVudCB3aXRoIGRldGFpbFR5cGUgPSAnQ2FyIFJlcGFpcmVkJ1xyXG4gICAgICBidWlsZGVyLndpdGhOYW1lKFwiRXZhbHVhdGVcIikud2l0aEV2ZW50TmFtZShcIkNhciBQcmljZWRcIikuYnVpbGQoKSAgLy9DcmVhdGUgYSBzdGF0ZSBuYW1lZCAnRXZhbHVhdGUnIHdoaWNoIHdhaXRzIGZvciBhbiBldmVudCB3aXRoIGRldGFpbFR5cGUgPSAnQ2FyIFByaWNlZCdcclxuICAgIClcclxuXHJcbiAgICBjb25zdCByZWFkeSA9IGJ1aWxkZXIud2l0aE5hbWUoXCJSZWFkeUZvclNhbGVcIikuYnVpbGQoKTtcclxuICAgIGNvbnN0IGF2YWlsYWJsZSA9IGJ1aWxkZXIud2l0aE5hbWUoXCJPblNhbGVcIikuYnVpbGQoKTtcclxuICAgIGNvbnN0IHJlc2VydmVkID0gYnVpbGRlci53aXRoTmFtZShcIlJlc2VydmVkXCIpLmJ1aWxkKCk7XHJcbiAgICBcclxuICAgIGNvbnN0IHNvbGQgPSBuZXcgUGFyYWxsZWwodGhpcywgXCJTb2xkXCIpO1xyXG4gICAgc29sZC5icmFuY2goXHJcbiAgICAgIGJ1aWxkZXIud2l0aE5hbWUoXCJEZWxpdmVyeVwiKS53aXRoRXZlbnROYW1lKFwiQ2FyIERlbGl2ZXJlZFwiKS5idWlsZCgpLFxyXG4gICAgICBidWlsZGVyLndpdGhOYW1lKFwiSW52b2ljZVwiKS53aXRoRXZlbnROYW1lKFwiSW52b2ljZSBTZW50XCIpLmJ1aWxkKClcclxuICAgIClcclxuXHJcbiAgICBjb25zdCB1bmV4cGVjdGVkVHJhbnNpdGlvbiA9IG5ldyBGYWlsKHRoaXMsIFwiVW5leHBlY3RlZCBUcmFuc2l0aW9uXCIpO1xyXG5cclxuICAgIHJldHVybiBhbm5vdW5jZWRcclxuICAgICAgLm5leHQobmV3IENob2ljZSh0aGlzLCBcIklzIEFjY2VwdGVkP1wiKVxyXG4gICAgICAgIC53aGVuKENvbmRpdGlvbi5hbmQoQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiSW5zcGVjdGlvbiBDb21wbGV0ZWRcIiksIENvbmRpdGlvbi5zdHJpbmdFcXVhbHMoXCIkLmRldGFpbC5yZXN1bHRcIiwgXCJSZWplY3RlZFwiKSksIHJlamVjdGVkKVxyXG4gICAgICAgIC53aGVuKENvbmRpdGlvbi5hbmQoQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiSW5zcGVjdGlvbiBDb21wbGV0ZWRcIiksIENvbmRpdGlvbi5zdHJpbmdFcXVhbHMoXCIkLmRldGFpbC5yZXN1bHRcIiwgXCJTdWNjZXNzXCIpKSxcclxuICAgICAgICAgIGluUHJlcGFyYXRpb24ubmV4dChyZWFkeSlcclxuICAgICAgICAgIC5uZXh0KG5ldyBDaG9pY2UodGhpcywgXCJJcyBPbiBTYWxlP1wiKVxyXG4gICAgICAgICAgICAud2hlbihDb25kaXRpb24uc3RyaW5nRXF1YWxzKFwiJC5ldmVudE5hbWVcIiwgXCJDYXIgUHVibGlzaGVkXCIpLCBhdmFpbGFibGVcclxuICAgICAgICAgICAgICAubmV4dChuZXcgQ2hvaWNlKHRoaXMsIFwiSXMgUmVzZXJ2ZWQ/XCIpXHJcbiAgICAgICAgICAgICAgICAud2hlbihDb25kaXRpb24uc3RyaW5nRXF1YWxzKFwiJC5ldmVudE5hbWVcIiwgXCJDYXIgVW5wdWJsaXNoZWRcIiksIHJlYWR5KVxyXG4gICAgICAgICAgICAgICAgLndoZW4oQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiQ2FyIFJlc2VydmVkXCIpLCBcclxuICAgICAgICAgICAgICAgICAgcmVzZXJ2ZWRcclxuICAgICAgICAgICAgICAgICAgLm5leHQobmV3IENob2ljZSh0aGlzLCBcIklzIFNvbGQ/XCIpXHJcbiAgICAgICAgICAgICAgICAgICAgLndoZW4oQ29uZGl0aW9uLnN0cmluZ0VxdWFscyhcIiQuZXZlbnROYW1lXCIsIFwiQ2FyIFVucmVzZXJ2ZWRcIiksIGF2YWlsYWJsZSlcclxuICAgICAgICAgICAgICAgICAgICAud2hlbihDb25kaXRpb24uc3RyaW5nRXF1YWxzKFwiJC5ldmVudE5hbWVcIiwgXCJDYXIgU29sZFwiKSwgc29sZClcclxuICAgICAgICAgICAgICAgICAgICAub3RoZXJ3aXNlKHVuZXhwZWN0ZWRUcmFuc2l0aW9uKVxyXG4gICAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAub3RoZXJ3aXNlKHVuZXhwZWN0ZWRUcmFuc2l0aW9uKVxyXG4gICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAub3RoZXJ3aXNlKHVuZXhwZWN0ZWRUcmFuc2l0aW9uKVxyXG4gICAgICAgICAgKVxyXG4gICAgICAgIClcclxuICAgICAgICAub3RoZXJ3aXNlKHVuZXhwZWN0ZWRUcmFuc2l0aW9uKVxyXG4gICAgICApO1xyXG4gIH1cclxufVxyXG5cclxuXHJcbiJdfQ==